<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Civil War Soldier Search</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    input {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Civil War Soldier Search</h1>
  <input type="text" id="search" placeholder="Search by name, birth, death..." />

  <table id="resultsTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <h2>Add New Soldier</h2>
  <form id="entry-form">
    <input name="Soldier" placeholder="Soldier Name" required />
    <input name="Born" placeholder="Birth Date" required />
    <input name="Died" placeholder="Death Date" required />
    <input name="EnlistedNumber" placeholder="EnlistedNumber" />
    <button type="submit">Submit</button>
  </form>

  <script>
    async function loadCSV() {
      const response = await fetch('soldiers.csv');
      const csv = await response.text();

      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          window.originalData = results.data;
          renderTable([]);
        }
      });
    }

    function renderTable(data) {
      const tableHead = document.querySelector("#resultsTable thead");
      const tableBody = document.querySelector("#resultsTable tbody");

      tableHead.innerHTML = '';
      tableBody.innerHTML = '';

      if (data.length === 0) {
        return;
      }

      const headers = Object.keys(data[0]);
      const headRow = document.createElement("tr");
      headers.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        headRow.appendChild(th);
      });
      tableHead.appendChild(headRow);

      data.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach(header => {
          const td = document.createElement("td");
          td.textContent = row[header];
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

    document.getElementById('search').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      if (query.trim() === '') {
        renderTable([]); // Don't show full dataset again
        return;
      }

      const filtered = window.originalData.filter(row =>
        Object.values(row).some(val => val.toLowerCase().includes(query))
      );
      renderTable(filtered);
    });

    document.getElementById('entry-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const payload = Object.fromEntries(formData.entries());

      const res = await fetch('https://olbmovl6t0.execute-api.us-east-1.amazonaws.com/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      alert(result.message || result.error);
      e.target.reset();
    });

    loadCSV();
  </script>
</body>
</html>
