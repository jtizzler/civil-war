<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Civil War Data</title>
</head>
<body>
  <h1>Civil War Soldiers</h1>
  <input type="text" id="search" placeholder="Search by name...">
  <div id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // let allData = [];

    // Papa.parse('soldiers.csv', {
    //   download: true,
    //   header: true,
    //   complete: function(results) {
    //     allData = results.data;
    //     // renderResults(allData);
    //   }
    // });

    let soldiersData = [];
    let unitsData = [];
    let joinedData = [];

    Papa.parse('soldiers.csv', {
      download: true,
      header: true,
      complete: function(results) {
        soldiersData = results.data;
        tryJoin();
      }
    });

    Papa.parse('units.csv', {
      download: true,
      header: true,
      complete: function(results) {
        unitsData = results.data;
        tryJoin();
      }
    });

    function tryJoin() {
      if (soldiersData.length === 0 || unitsData.length === 0) return;

      // Index units by EnlistedNumber
      const unitMap = {};
      unitsMap.forEach(unit => {
        unitMap[unit.EnlistedNumber] = unit;
      });

      // Join soldiers with thir unit info

      joinedData = soldiersData.map(soldier => {
        const unit = unitMap[soldier.EnlistedNumber] || {};
        return { ...soldier, ...unit };
      });

      // Do not render on load (per previous request)
      // renderResults(joinedData);
    }
    
    function renderResults(data) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (data.length ===0) {
        resultsDiv.textContent = 'No results found.';
        return;
      }

      const table = document.createElement('table');
      table.border = '1';
      const headerRow = document.createElement('tr');

      // Create Header
      Object.keys(data[0]).forEach(key => {
        const th = document.createElement('th');
        th.textContent = key;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      // Create Rows
      data.forEach(row => {
        const tr = document.createElement('tr');
        Object.values(row).forEach(val => {
          const td = document.createElement('td');
          td.textContent = val;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });

      resultsDiv.appendChild(table);
    }
    //   data.forEach(row => {
    //     const p = document.createElement('p');
    //     p.textContent = JSON.stringify(row);
    //     resultsDiv.appendChild(p);
    //   });
    // }

    document.getElementById('search').addEventListener('input', function(e) {
      const searchVal = e.target.value.toLowerCase();
      if (!searchVal) {
        // Show a placeholder message if the search box is empty
        document.getElementById('results').textContent = 'Please enter a search query to display results.';
        return;
      }
      const filtered = joinedData.filter (row =>
      // const filtered = allData.filter(row =>
        Object.values(row).some(
          val => val && val.toLowerCase().includes(searchVal)
        )
      );
      renderResults(filtered);
    });
  </script>
</body>
</html>
